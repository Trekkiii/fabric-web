# fabric-ca

å‡è®¾ä½ å·²ç»é…ç½®goã€dockerç¯å¢ƒï¼Œå¹¶è®¾ç½®ç›¸å…³ç¯å¢ƒå˜é‡ã€‚
å¦‚æœæ²¡æœ‰ï¼Œè¯·å‚è€ƒï¼š[>> README](https://github.com/fnpac/fabric-samples-cn/blob/master/README.md)

é€šè¿‡å¦‚ä¸‹è„šæœ¬ä¸‹è½½æ‰€éœ€çš„æ‰€æœ‰é•œåƒï¼š

```bash
./down-images.sh
```

## ä½¿ç”¨æ­¥éª¤

è¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¸ºè„šæœ¬å¢åŠ æ‰§è¡Œæƒé™ï¼š

```bash
root@vm10-249-0-4:~/fabric-web/fabric-ca# chmod +x *.sh
root@vm10-249-0-4:~/fabric-web/fabric-ca# 
root@vm10-249-0-4:~/fabric-web/fabric-ca# 
root@vm10-249-0-4:~/fabric-web/fabric-ca# chmod +x scripts/*.sh
```

### 0. ç½‘ç»œæ‹“æ‰‘

é€šè¿‡`fabric.config`å®šä¹‰ç½‘ç»œæ‹“æ‰‘ç»“æ„

### 1.æ„å»ºé¡¹ç›®ï¼Œä¸ºä¸åŒèŠ‚ç‚¹æ‰“åŒ…è„šæœ¬

```bash
./network_builder.sh
```

å†æ­£å¼å¼€å§‹å‰ï¼Œç¡®ä¿ä½ å·²ç»æ­£ç¡®å®Œæˆä¸‹åˆ—æ­¥éª¤æ‰§è¡Œï¼š

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬æ‹¿ä»£ç ä¸­æä¾›çš„ç¤ºä¾‹`fabric.config`é…ç½®æ–‡ä»¶åšè¯´æ˜ï¼š
    
* å°†`build`ç›®å½•ä¸‹ç”Ÿæˆçš„æ–‡ä»¶å¤¹åˆ†åˆ«æ‹·è´åˆ°ç›¸åº”èŠ‚ç‚¹çš„ **_`fabric.config`é…ç½®ä¸­æŒ‡å®šç”¨æˆ·çš„æŒ‡å®šç›®å½•_** ä¸‹ï¼›
    
    ```bash
    scp -r ica ubuntu@<IP>:~/fabric/ica
    scp -r rca  ubuntu@<IP>:~/fabric/rca
    scp -r peer  ubuntu@<IP>:~/fabric/peer
    scp -r orderer  ubuntu@<IP>:~/fabric/orderer
    ```
    
    ç›®å½•åº”è¯¥æ˜¯è¿™ä¸ªæ ·å­ï¼š
    
    ![](./ica-tree.png)
    
* æ¯ä¸ªèŠ‚ç‚¹éƒ½å·²ä¸‹è½½æ‰€éœ€çš„fabricé•œåƒï¼›

    å¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä¸‹è½½é•œåƒ:
    
    ```bash
    ./down-images.sh
    ```

### 2.å¯åŠ¨CAæœåŠ¡

å¯¹äºæ¯ä¸€ä¸ªç»„ç»‡éƒ½è¦å¯åŠ¨ä¸€ä¸ªrcaå’ŒicaæœåŠ¡ã€‚

##### 2.1. rca(root ca)

ä¸€ä¸ªç»„ç»‡å¯¹åº”ä¸€ä¸ª **_root fabric-ca-server_**

å¯åŠ¨æŒ‡å®šç»„ç»‡`<ORG>`çš„ **_root fabric-ca-server_** å‘½ä»¤å¦‚ä¸‹

```bash
./rca-bootstrap.sh <ORG>
```

è„šæœ¬ä¼šåœ¨root CA åˆå§‹åŒ–æ—¶ï¼Œåœ¨`/etc/hyperledger/fabric-ca`ç›®å½•ä¸‹ç”Ÿæˆ`ca-cert.pem`è¯ä¹¦ï¼Œå¹¶å°†å…¶æ‹·è´ä¸º`/${DATA}/${ORG}-ca-cert.pem`ã€‚

##### 2.2. ica(intermediate ca)

ä¸€ä¸ªç»„ç»‡å¯¹åº”ä¸€ä¸ª **_intermediate fabric-ca-server_**

å¯åŠ¨æŒ‡å®šç»„ç»‡`<ORG>`çš„ **_intermediate fabric-ca-server_** å‘½ä»¤å¦‚ä¸‹

```bash
./ica-bootstrap.sh <ORG>
```

è„šæœ¬ä¼šåœ¨intermediate CA åˆå§‹åŒ–æ—¶ï¼Œåœ¨`/etc/hyperledger/fabric-ca`ç›®å½•ä¸‹ç”Ÿæˆ`ca-chain.pem`è¯ä¹¦ï¼Œå¹¶å°†å…¶æ‹·è´ä¸º`/${DATA}/${ORG}-ca-chain.pem`ã€‚

>å…¶å®ƒèŠ‚ç‚¹ä¸‹åˆ—æ“ä½œéœ€è¦ä½¿ç”¨rca(`USE_INTERMEDIATE_CA`ä¸º`false`æ—¶)æˆ–è€…ica(`USE_INTERMEDIATE_CA`ä¸ºtrue`æ—¶)æ ¹è¯ä¹¦
>
>- å‘CAæœåŠ¡ç«¯ç”³è¯·æ ¹è¯ä¹¦æ—¶ä½¿ç”¨;
>- å‘CAæœåŠ¡ç«¯ç™»è®°CAç®¡ç†å‘˜èº«ä»½æ—¶ä½¿ç”¨;
>    
>    ä¹‹æ‰€ä»¥*ç™»è®°CAç®¡ç†å‘˜èº«ä»½*ï¼Œæ˜¯å› ä¸ºéœ€è¦ä½¿ç”¨CAç®¡ç†å‘˜èº«ä»½å»æ³¨å†Œordererå’Œpeerç›¸å…³ç”¨æˆ·å®ä½“ã€‚
>    
>    **_!!! æ‰§è¡Œæ³¨å†Œæ–°ç”¨æˆ·å®ä½“çš„å®¢æˆ·ç«¯å¿…é¡»å·²ç»é€šè¿‡ç™»è®°è®¤è¯ï¼Œå¹¶ä¸”æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™æ¥è¿›è¡Œæ³¨å†Œ !!!_**
>
>- å‘CAæœåŠ¡ç«¯ç™»è®° **_Ordererç»„ç»‡ç®¡ç†å‘˜èº«ä»½å’ŒPeerç»„ç»‡ç®¡ç†å‘˜èº«ä»½_**ã€**_OrdererèŠ‚ç‚¹èº«ä»½å’ŒPeerèŠ‚ç‚¹èº«ä»½_**ï¼Œä»¥åŠ **_Peerç»„ç»‡æ™®é€šç”¨æˆ·èº«ä»½_** æ—¶ä½¿ç”¨;

å› æ­¤ï¼Œ

- `USE_INTERMEDIATE_CA`ä¸º`false`ï¼Œå³æœªå¯ç”¨ä¸­é—´å±‚CAæ—¶ï¼Œ**_éœ€è¦å°†`/etc/hyperledger/fabric-ca/ca-cert.pem`æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹ä½œä¸º`CA_CHAINFILE`_**ï¼›
- `USE_INTERMEDIATE_CA`ä¸º`true`ï¼Œå³å¯ç”¨ä¸­é—´å±‚CAæ—¶ï¼Œ**_éœ€è¦å°†`/etc/hyperledger/fabric-ca/ca-chain.pem`æ‹·è´åˆ°å…¶å®ƒèŠ‚ç‚¹ä½œä¸º`CA_CHAINFILE`_**;

ä¸å¿…æ‹…å¿ƒï¼Œè¿™äº›å·¥ä½œè„šæœ¬å·²ç»å¸®æˆ‘ä»¬å®Œæˆäº†ï¼~ :laughing: 

é‡‡ç”¨çš„æ–¹æ³•æ˜¯å…¶å®ƒèŠ‚ç‚¹é€šè¿‡ **_sshè¿œç¨‹æ‹·è´caä¸Šçš„æ ¹è¯ä¹¦_** ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨`fabric.config`ä¸­é…ç½®äº†CAçš„`USER_NAME`ã€`PATH`ï¼Œ
ä½†è¿™éœ€è¦ä½ åœ¨è„šæœ¬æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸è„šæœ¬äº¤äº’ï¼Œè¾“å…¥å¯¹åº”CAæœåŠ¡å™¨çš„å¯†ç ï¼Œå¦‚æœä½ æƒ³é¿å…è¿™ä¸€æ­¥éª¤ï¼Œå¯ä»¥è€ƒè™‘é…ç½®sshå…ç™»é™†ã€‚ 

> ğŸ’¡ !!!ç¡®ä¿:
> - CAæœåŠ¡ç«¯å¼€å¯22ç«¯å£ï¼›
> - CAæœåŠ¡ç«¯çš„DATAç›®å½•çš„æ‰€æœ‰è€…ä¸º`fabric.config`ä¸­çš„`CA.USER_NAME`ï¼Œå¦åˆ™æ— æ³•è¿œç¨‹è·å–ä¸Šè¿°è¯ä¹¦(ä¸ºç¡®ä¿è¿™ä¸€ç‚¹ï¼Œè¯·ä¸è¦ä½¿ç”¨`sudo`å¯åŠ¨è„šæœ¬)ï¼›

åŒæ ·çš„ï¼Œè¿˜æœ‰`setup`èŠ‚ç‚¹ï¼Œä¸å†èµ˜è¿°ã€‚

- `orderer`èŠ‚ç‚¹éœ€è¦ä»`setup`èŠ‚ç‚¹è·å–åˆ›ä¸–åŒºå—
- `run`èŠ‚ç‚¹éœ€è¦ä»`setup`èŠ‚ç‚¹è·å–åº”ç”¨é€šé“é…ç½®äº¤æ˜“æ–‡ä»¶ã€é”šèŠ‚ç‚¹é…ç½®æ›´æ–°äº¤æ˜“æ–‡ä»¶

è¿™äº›å·¥ä½œè„šæœ¬ä¹Ÿå·²ç»å¸®æˆ‘ä»¬å®Œæˆäº†ï¼~ âœŒ 

### 3. å¯åŠ¨setup

setupå®¹å™¨ç”¨äºï¼š

- å‘ä¸­é—´å±‚fabric-ca-serversæ³¨å†ŒOrdererå’ŒPeerèº«ä»½
- æ„å»ºé€šé“Artifactsï¼ˆåŒ…æ‹¬ï¼šåˆ›ä¸–åŒºå—ã€åº”ç”¨é€šé“é…ç½®äº¤æ˜“æ–‡ä»¶ã€é”šèŠ‚ç‚¹é…ç½®æ›´æ–°äº¤æ˜“æ–‡ä»¶ï¼‰
- å¯åŠ¨'run'å®¹å™¨ï¼Œæ‰§è¡Œåˆ›å»ºåº”ç”¨é€šé“ã€åŠ å…¥åº”ç”¨é€šé“ã€æ›´æ–°é”šèŠ‚ç‚¹ã€å®‰è£…é“¾ç ã€å®ä¾‹åŒ–é“¾ç ã€æŸ¥è¯¢è°ƒç”¨é“¾ç ç­‰æ“ä½œ

> åŠ¡å¿…åœ¨æ‰§è¡Œå®Œæ­¥éª¤2ï¼Œå†æ‰§è¡Œæ­¤æ­¥éª¤ã€‚ç¡®ä¿å·²æˆåŠŸå¯åŠ¨æ‰€æœ‰ç»„ç»‡çš„`rca`ã€`ica`èŠ‚ç‚¹ã€‚

```text
setup-bootstrap.sh [-h] [-?] [-d]
            -h|-?       è·å–æ­¤å¸®åŠ©ä¿¡æ¯
            -d          ä»ç½‘ç»œä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
```

* è„šæœ¬éœ€è¦ä½¿ç”¨fabricçš„äºŒè¿›åˆ¶æ–‡ä»¶`configtxgen`ï¼Œè¯·å°†è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ç½®äºPATHè·¯å¾„ä¸‹ã€‚

    å¦‚æœè„šæœ¬æ‰¾ä¸åˆ°ï¼Œä¼šåŸºäº[fabricæºç ](https://github.com/hyperledger/fabric)è‡ªåŠ¨ç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
    æ­¤æ—¶éœ€è¦ä¿è¯`$HOME/gopath/src/github.com/hyperledger/fabric`æºç å­˜åœ¨ï¼Œä¸”ç‰ˆæœ¬ä¸€è‡´ã€‚
    
    å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š`-d`é€‰é¡¹ä»ç½‘ç»œä¸‹è½½è¯¥äºŒè¿›åˆ¶æ–‡ä»¶

* ~~è„šæœ¬éœ€è¦ä½¿ç”¨fabricçš„äºŒè¿›åˆ¶æ–‡ä»¶`fabric-ca-client`ï¼Œè¯·å°†è¯¥äºŒè¿›åˆ¶æ–‡ä»¶ç½®äºPATHè·¯å¾„ä¸‹~~ã€‚

    ~~å¦‚æœè„šæœ¬æ‰¾ä¸åˆ°ï¼Œä¼šåŸºäº[fabric caæºç ](https://github.com/hyperledger/fabric-ca)è‡ªåŠ¨ç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ
    æ­¤æ—¶éœ€è¦ä¿è¯`$HOME/gopath/src/github.com/hyperledger/fabric-ca`æºç å­˜åœ¨ï¼Œä¸”ç‰ˆæœ¬ä¸€è‡´ã€‚~~

    ~~ç¼–è¯‘`fabric-ca`ç›¸å…³ä»£ç ï¼Œéœ€è¦ä¸€äº›ä¾èµ–åŒ…ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®‰è£…:~~

    ```bash
    sudo apt-get install libtool libltdl-dev
    ```

    ~~è„šæœ¬ä¼šå°†ç¼–è¯‘ç”Ÿæˆçš„`fabric-ca-server`å’Œ`fabric-ca-client`ä¿å­˜åœ¨`$GOPATH/bin`ç›®å½•ä¸‹ã€‚~~

* æ­¤å¤–ï¼Œä½ è¿˜éœ€è¦é…ç½®å½“å‰æœºå™¨çš„`/etc/host`ï¼Œå†…å®¹å‚è§`build/host.config`ã€‚
* å°†å®‰è£…çš„é“¾ç å¤åˆ¶åˆ°'setup'åŒçº§ç›®å½•ä¸‹ã€‚

å¦‚æœä½ æ‰§è¡Œå®Œä¸Šè¿°ï¼Œé‚£ä¹ˆæ¥å¯åŠ¨`setup`å§ï¼~ğŸ˜

```bash
./setup-bootstrap.sh
```

### 4. å¯åŠ¨orderer

```text
orderer-bootstrap.sh [-h] [-?] <ORG> <NUM>
    -h|-?  - è·å–æ­¤å¸®åŠ©ä¿¡æ¯
    <ORG>   - å¯åŠ¨çš„ordererç»„ç»‡åç§°
    <NUM>   - å¯åŠ¨çš„ordererç»„ç»‡çš„ç¬¬å‡ ä¸ªèŠ‚ç‚¹
```

```bash
./orderer-bootstrap.sh <ORG> <NUM>
```

### 5. å¯åŠ¨peer

```text
peer-bootstrap.sh [-h] [-?] <ORG> <NUM>
    -h|-?  - è·å–æ­¤å¸®åŠ©ä¿¡æ¯
    <ORG>   - å¯åŠ¨çš„peerç»„ç»‡çš„åç§°
    <NUM>   - å¯åŠ¨çš„peerç»„ç»‡çš„èŠ‚ç‚¹ç´¢å¼•
```

```bash
./peer-bootstrap.sh <ORG> <NUM>
```

## TODO

- ordererå¢åŠ kafkaé›†ç¾¤
- è´¦æœ¬å­˜å‚¨ä½¿ç”¨couchdb

## ç‰ˆæœ¬å†å²

### v1.0.1

* æ–°å¢`expect`ï¼Œå…å»æ‰‹åŠ¨è¾“å…¥å¯†ç çš„çƒ¦æ¼ï¼›